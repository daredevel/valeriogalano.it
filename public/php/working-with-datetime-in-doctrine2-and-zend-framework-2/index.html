<!DOCTYPE html>
<html>

    <head>
        <title> Working with DateTime in Doctrine 2 and Zend Framework 2 &middot; Valerio Galano - Software developer </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.62.0" />


<script src="/js/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous" async></script>


<link rel="stylesheet" href="/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous" async></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">


<link rel="stylesheet" href="https://valeriogalano.it/css/nix.css">



<link rel="shortcut icon" href="/img/favicon.ico">








<script type="text/javascript">
    var _iub = _iub || [];
    _iub.csConfiguration = {"lang":"it","siteId":110958,"consentOnLinkAndButton":false,"consentOnElement":null,"consentOnScroll":false,"cookiePolicyId":521121, "banner":{ "acceptButtonDisplay":true,"customizeButtonDisplay":true,"position":"float-top-center","acceptButtonColor":"#0073CE","acceptButtonCaptionColor":"white","customizeButtonColor":"#DADADA","customizeButtonCaptionColor":"#4D4D4D","textColor":"black","backgroundColor":"white" }};
    </script><script type="text/javascript" src="//cdn.iubenda.com/cs/iubenda_cs.js" charset="UTF-8" async></script><meta property="og:title" content="Working with DateTime in Doctrine 2 and Zend Framework 2" />
<meta property="og:description" content="The problem Storing datetimes can be a issue if servers and users of your application are distributed around the World and use different time zones. Each user want to work on datetimes in his specific time zone, servers automatically stores values in their time zone, etc. Storing data without operating right conversion will cause strange behaviours.
The solution The solution is very simple: store all datetimes in UTC time zone and show to each user in his proper time zone." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://valeriogalano.it/php/working-with-datetime-in-doctrine2-and-zend-framework-2/" />
<meta property="og:image" content="https://valeriogalano.it/img/profile.jpg"/>
<meta property="article:published_time" content="2013-03-12T09:52:39+00:00" />
<meta property="article:modified_time" content="2013-03-12T09:52:39+00:00" /><meta property="og:site_name" content="Valerio Galano" />
<meta itemprop="name" content="Working with DateTime in Doctrine 2 and Zend Framework 2">
<meta itemprop="description" content="The problem Storing datetimes can be a issue if servers and users of your application are distributed around the World and use different time zones. Each user want to work on datetimes in his specific time zone, servers automatically stores values in their time zone, etc. Storing data without operating right conversion will cause strange behaviours.
The solution The solution is very simple: store all datetimes in UTC time zone and show to each user in his proper time zone.">
<meta itemprop="datePublished" content="2013-03-12T09:52:39&#43;00:00" />
<meta itemprop="dateModified" content="2013-03-12T09:52:39&#43;00:00" />
<meta itemprop="wordCount" content="624">
<meta itemprop="image" content="https://valeriogalano.it/img/profile.jpg"/>



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://valeriogalano.it/img/profile.jpg"/>

<meta name="twitter:title" content="Working with DateTime in Doctrine 2 and Zend Framework 2"/>
<meta name="twitter:description" content="The problem Storing datetimes can be a issue if servers and users of your application are distributed around the World and use different time zones. Each user want to work on datetimes in his specific time zone, servers automatically stores values in their time zone, etc. Storing data without operating right conversion will cause strange behaviours.
The solution The solution is very simple: store all datetimes in UTC time zone and show to each user in his proper time zone."/>


    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://valeriogalano.it/>valerio@daredevel ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="https://valeriogalano.it/">/home/valerio</a>
				</li>
				
				
				<li class="dropdown">
                    
            		<a href="/post">~/blog</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://pensieriincodice.it/">~/podcast</a>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="container wrapper">
            <h1><a href="https://valeriogalano.it/php/working-with-datetime-in-doctrine2-and-zend-framework-2/">Working with DateTime in Doctrine 2 and Zend Framework 2</a></h1>
            <span class="post-date">Mar 12, 2013 </span>
            <div class="post-content">
                <h2 id="the-problem">The problem</h2>
<p>Storing datetimes can be a issue if servers and users of your application are distributed around the World and use different time zones. Each user want to work on datetimes in his specific time zone, servers automatically stores values in their time zone, etc. Storing data without operating right conversion will cause strange behaviours.</p>
<h2 id="the-solution">The solution</h2>
<p>The solution is very simple: store all datetimes in UTC time zone and show to each user in his proper time zone. This is, gnerally, a well documented technique, but the following code will explain how to realize this operation in <a href="http://www.doctrine-project.org/">Doctrine 2</a> and <a href="http://framework.zend.com/">Zend Framework 2</a> environment. To do this, we will assume you just have a working ZF2 project with a configured <a href="https://github.com/doctrine/DoctrineORMModule">DoctrineORMModule</a> (refer to official documentation to reach this achievement).</p>
<p>First of all, lets create a custom Doctrine Datatype to handle <a href="http://www.php.net/manual/en/book.datetime.php">DateTime</a> object in UTC. Field of this type will automatically convert value into UTC time zone before store it in DB. The following code is a modification of official doctrine <a href="http://docs.doctrine-project.org/en/latest/cookbook/working-with-datetime.html">Working with DateTime instances</a> article that at this moment (2013-03-12) has an error in usage of DateTime format() method. Please, note that you can put this file where you prefer inside /module/Application/src/Application/.</p>
<p>/module/Application/src/Application/DBAL/Types/UTCDateTimeType.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">ApplicationDBALTypes</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">DoctrineDBALPlatformsAbstractPlatform</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">DoctrineDBALTypesConversionException</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UTCDateTimeType</span> <span class="k">extends</span> <span class="nx">DoctrineDBALTypesDateTimeType</span>
<span class="p">{</span>

     <span class="k">static</span> <span class="k">private</span> <span class="nv">$utc</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

     <span class="sd">/**
</span><span class="sd">      * @param DateTime $value
</span><span class="sd">      * @param DoctrineDBALPlatformsAbstractPlatform $platform
</span><span class="sd">      * @return string
</span><span class="sd">      */</span>
     <span class="k">public</span> <span class="k">function</span> <span class="nf">convertToDatabaseValue</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nx">AbstractPlatform</span> <span class="nv">$platform</span><span class="p">)</span>
     <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$formatString</span> <span class="o">=</span> <span class="nv">$platform</span><span class="o">-&gt;</span><span class="na">getDateTimeFormatString</span><span class="p">();</span>

        <span class="nv">$value</span><span class="o">-&gt;</span><span class="na">setTimezone</span><span class="p">((</span><span class="nx">self</span><span class="o">::</span><span class="nv">$utc</span><span class="p">)</span> <span class="o">?</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$utc</span> <span class="o">:</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$utc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DateTimeZone</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">)));</span>

        <span class="nv">$formatted</span> <span class="o">=</span> <span class="nv">$value</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="nv">$formatString</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$formatted</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
</span><span class="sd">     * @param string $value
</span><span class="sd">     * @param DoctrineDBALPlatformsAbstractPlatform $platform
</span><span class="sd">     * @return DateTime|mixed|null
</span><span class="sd">     * @throws DoctrineDBALTypesConversionException
</span><span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">convertToPHPValue</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nx">AbstractPlatform</span> <span class="nv">$platform</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$val</span> <span class="o">=</span> <span class="nx">DateTime</span><span class="o">::</span><span class="na">createFromFormat</span><span class="p">(</span>
            <span class="nv">$platform</span><span class="o">-&gt;</span><span class="na">getDateTimeFormatString</span><span class="p">(),</span>
            <span class="nv">$value</span><span class="p">,</span>
            <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$utc</span><span class="p">)</span> <span class="o">?</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$utc</span> <span class="o">:</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$utc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DateTimeZone</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">))</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">ConversionException</span><span class="o">::</span><span class="na">conversionFailed</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$val</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>To make this Datatype work in a Zend Framework 2 project, we need to load it in our DoctrineORMModule configuration. So let's edit ZF2 module configuration file by adding the following code:</p>
<p>/module/Application/config/module.config.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">return array(
    ...
    &#39;doctrine&#39; =&gt; array(
        &#39;configuration&#39; =&gt; array(
            &#39;orm_default&#39; =&gt; array(
                ...
                &#39;types&#39; =&gt; array(
                    &#39;utcdatetime&#39; =&gt; &#39;ApplicationDBALTypesUTCDateTimeType&#39;,
                ),
                ...
            )
        ),
    ),
    ...
);</code></pre></td></tr></table>
</div>
</div>
<p>At this point we can use Datatype UTCDateTime to map DateTime property of our entities like in the following example. Please note that the location of entities depends on your DoctrineORMModule configuration.</p>
<p>/module/Application/src/Application/Entity/Event.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">/**
 * @Entity
 * @Table(name=&#34;myEvent)
 */
class Event
{
    ...

    /**
     * @Column(type=&#34;UTCDateTime&#34;)
     * @var DateTime
     */
     protected $datetime;

    ...
}</code></pre></td></tr></table>
</div>
</div>
<p>Now, when we use $event-&gt;setDatetime() method, the value will be stored in DB in UTC time zone. For this reason, we need to re-convert it into user time zone before show.</p>
<p>After retrieved an object that contains a DateTime property, let's set timezone before show with code like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">...
echo $event-&gt;getDatetime()-&gt;setTimezone(new DateTimeZone(&#39;Europe/Rome&#39;))-&gt;format(&#39;d/m/Y H:i&#39;);
...</code></pre></td></tr></table>
</div>
</div>
<p>Please note that time zone and format strings can be retrieved from user preference or automatically detected.</p>
<h2 id="conclusion">Conclusion</h2>
<p>At this point we can simply work with DateTime in Doctrine 2 + Zend Framework2 environment.</p>
<p>Please, keep in mind that this is only an example and can be heavly improved.</p>

            </div>
            
            <div class="post-comments">
                
<div id="disqus_thread"></div>
<script type="text/plain" class="_iub_cs_activate" data-iub-purposes="3">

(function() {
    // Don't ever inject Disqus on localhost--it creates unwanted
    // discussions from 'localhost:1313' on your Disqus account...
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'daredevel';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>Copyright &copy; 2019 Valerio Galano -
	<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme
</span> -
<a href="https://www.iubenda.com/privacy-policy/521121" class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy ">Privacy Policy</a><script type="text/javascript">(function (w,d) {var loader = function () {var s = d.createElement("script"), tag = d.getElementsByTagName("script")[0]; s.src="https://cdn.iubenda.com/iubenda.js"; tag.parentNode.insertBefore(s,tag);}; if(w.addEventListener){w.addEventListener("load", loader, false);}else if(w.attachEvent){w.attachEvent("onload", loader);}else{w.onload = loader;}})(window, document);</script>
</p>
</footer>

    </body>
