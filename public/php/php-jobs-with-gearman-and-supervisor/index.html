<!DOCTYPE html>
<html>

    <head>
        <title> PHP jobs with Gearman and Supervisor &middot; Valerio Galano - Software developer </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.62.0" />


<script src="/js/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous" async></script>


<link rel="stylesheet" href="/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous" async></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">


<link rel="stylesheet" href="https://valeriogalano.it/css/nix.css">



<link rel="shortcut icon" href="/img/favicon.ico">








<script type="text/javascript">
    var _iub = _iub || [];
    _iub.csConfiguration = {"lang":"it","siteId":110958,"consentOnLinkAndButton":false,"consentOnElement":null,"consentOnScroll":false,"cookiePolicyId":521121, "banner":{ "acceptButtonDisplay":true,"customizeButtonDisplay":true,"position":"float-top-center","acceptButtonColor":"#0073CE","acceptButtonCaptionColor":"white","customizeButtonColor":"#DADADA","customizeButtonCaptionColor":"#4D4D4D","textColor":"black","backgroundColor":"white" }};
    </script><script type="text/javascript" src="//cdn.iubenda.com/cs/iubenda_cs.js" charset="UTF-8" async></script><meta property="og:title" content="PHP jobs with Gearman and Supervisor" />
<meta property="og:description" content="The problem Often in a PHP project there could be operations that need to be executed asynchronously. Some example are: processing mail queues, indexing data, computation that requires long elaboration time.
A common behavior is handle those operations by using cron to execute processes in background. However, using cron requires expedients to avoid cross executions and forces us to implement some specific procedures and mechanism to store data needed to elaborate." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://valeriogalano.it/php/php-jobs-with-gearman-and-supervisor/" />
<meta property="og:image" content="https://valeriogalano.it/img/profile.jpg"/>
<meta property="article:published_time" content="2013-06-09T10:45:22+00:00" />
<meta property="article:modified_time" content="2013-06-09T10:45:22+00:00" /><meta property="og:site_name" content="Valerio Galano" />
<meta itemprop="name" content="PHP jobs with Gearman and Supervisor">
<meta itemprop="description" content="The problem Often in a PHP project there could be operations that need to be executed asynchronously. Some example are: processing mail queues, indexing data, computation that requires long elaboration time.
A common behavior is handle those operations by using cron to execute processes in background. However, using cron requires expedients to avoid cross executions and forces us to implement some specific procedures and mechanism to store data needed to elaborate.">
<meta itemprop="datePublished" content="2013-06-09T10:45:22&#43;00:00" />
<meta itemprop="dateModified" content="2013-06-09T10:45:22&#43;00:00" />
<meta itemprop="wordCount" content="637">
<meta itemprop="image" content="https://valeriogalano.it/img/profile.jpg"/>



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://valeriogalano.it/img/profile.jpg"/>

<meta name="twitter:title" content="PHP jobs with Gearman and Supervisor"/>
<meta name="twitter:description" content="The problem Often in a PHP project there could be operations that need to be executed asynchronously. Some example are: processing mail queues, indexing data, computation that requires long elaboration time.
A common behavior is handle those operations by using cron to execute processes in background. However, using cron requires expedients to avoid cross executions and forces us to implement some specific procedures and mechanism to store data needed to elaborate."/>


    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://valeriogalano.it/>valerio@daredevel ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="https://valeriogalano.it/">/home/valerio</a>
				</li>
				
				
				<li class="dropdown">
                    
            		<a href="/post">~/blog</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://pensieriincodice.it/">~/podcast</a>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="container wrapper">
            <h1><a href="https://valeriogalano.it/php/php-jobs-with-gearman-and-supervisor/">PHP jobs with Gearman and Supervisor</a></h1>
            <span class="post-date">Jun 9, 2013 </span>
            <div class="post-content">
                <h2 id="the-problem">The problem</h2>
<p>Often in a PHP project there could be operations that need to be executed asynchronously. Some example are: processing mail queues, indexing data, computation that requires long elaboration time.</p>
<p>A common behavior is handle those operations by using cron to execute processes in background. However, using cron requires expedients to avoid cross executions and forces us to implement some specific procedures and mechanism to store data needed to elaborate.</p>
<h2 id="solution-gearman--supervisor">Solution: Gearman + Supervisor</h2>
<p>The solution that involves Gearman and Supervisor, instead, don't require any kind of data storage mechanism and supply a very simple way to develop processes in PHP.</p>
<p>From</p>
<p><a href="http://www.gearman.org/">Gearman homepage</a>:</p>
<blockquote>
<p>Gearman provides a generic application framework to farm out work to other machines or processes that are better suited to do the work. It allows you to do work in parallel, to load balance processing, and to call functions between languages. It can be used in a variety of applications, from high-availability web sites to the transport of database replication events. In other words, it is the nervous system for how distributed processing communicates.</p>
</blockquote>
<p>Moreover, to develop clients and workers for Gearman in PHP is very simple as you can see in this <a href="http://it2.php.net/manual/en/gearman.examples-reverse.php">Gearman PHP documentation example</a>.</p>
<p>On the other hand, as written on <a href="http://supervisord.org/">Supervisor homepage</a>:</p>
<blockquote>
<p>Supervisor, is a client/server system that allows its users to monitor and control a number of processes on UNIX-like operating systems.</p>
</blockquote>
<p>Actually, combination of Gearman and Supervisor creates a <strong>stable, flexible</strong> and <strong>scalable</strong> infrastructure to handle all our jobs. As shown in the following diagram, it provides us a client/server structure and cares about communication and (if we want) distribution. We only need to take care of code to complete our tasks.</p>
<figure>
    <img src="/img/gearman_stack.png"
         alt="Gearman stack"/> <figcaption>
            <h4>Gearman stack</h4>
        </figcaption>
</figure>

<h2 id="installation">Installation</h2>
<p>I'm going to show how to install and setup Gearman and Supervisor in debian wheezy environment.</p>
<p>Normally, following packages should be present in a php ready system, but we want to be sure:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ apt-get install apache2 php5 libapache2-mod-php5 php5-dev</code></pre></div>
<p>Now we are ready to start Gearman installation. Required command is the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ apt-get install gearman-job-server libgearman-dev</code></pre></div>
<p>At this point, we need to install Gearman Pecl extension in order to use required PHP Classes. In a perfect World, we should simply install latest version, but (at the moment) latest stable Gearman Pecl requires a libgearman version newer then that included in debian repositories and, if we try to install it, we should recieve an error like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">configure: error: libgearman version 1.1.0 or later required
ERROR: <span class="sb">`</span>/tmp/pear/temp/gearman/configure<span class="err">&#39;</span> failed</code></pre></div>
<p>To resolve this issue, we could compile and install libgearman by ourself, or, as I prefer, install an older pecl extension version by running following commands:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ apt-get install php-pear
$ pecl install gearman-1.0.3</code></pre></div>
<p>Note: If you prefer compile libgearman yourself, you will easly find a way on Google.</p>
<p>To complete installation, following commands activate Gearman extension for Apache2:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">echo</span> <span class="s2">&#34;extension=gearman.so&#34;</span> &gt; /etc/php5/conf.d/gearman.ini
$ service apache2 restart</code></pre></div>
<p>At this point, we are ready to create our Gearman workers and clients as described in <a href="http://it2.php.net/manual/en/book.gearman.php">Gearman section of PHP documentation</a>.</p>
<p>But we are not satisfied yet: we also want to handle our php processes in a smart way. We want to be able to control them, monitor them and specify things like: how many instances, priority, etc. In a few words, we want to run them through Supervisor.</p>
<p>So, let's start to install it:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ apt-get install supervisor</code></pre></div>
<p>In debian, supervisor is a deamon and can be started/stopped using usual commands:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ service supervisor start
$ service supervisor stop</code></pre></div>
<p>Last step is configure our Gearman workers in Supervisor. To do that, we will create files in <em>/etc/supervisor/conf.d/</em> that will contain something like this:</p>
<p>/etc/supervisor/conf.d/myprocess.conf:</p>
<div class="highlight"><pre class="chroma"><code class="language-ini" data-lang="ini"><span class="k">[program:myprocess]</span>
<span class="na">command</span><span class="o">=</span><span class="s">php /path/to/project/myprocess.php</span>
<span class="na">numprocs</span><span class="o">=</span><span class="s">12</span>
<span class="na">directory</span><span class="o">=</span><span class="s">/path/to/project/spool/myprocess/</span>
<span class="na">autostart</span><span class="o">=</span><span class="s">true</span>
<span class="na">autorestart</span><span class="o">=</span><span class="s">true</span>
<span class="na">stdout_logfile</span><span class="o">=</span><span class="s">/path/to/project/log/myprocess.log</span>
<span class="na">stdout_logfile_maxbytes</span><span class="o">=</span><span class="s">1MB</span>
<span class="na">stderr_logfile</span><span class="o">=</span><span class="s">/path/to/project/log/myprocess.log</span>
<span class="na">stderr_logfile_maxbytes</span><span class="o">=</span><span class="s">1MB</span></code></pre></div>
<p>For a complete list of options, please see <a href="http://supervisord.org/">Supervisor documentation</a>.</p>
<h3 id="references">References:</h3>
<ul>
<li><a href="http://www.gearman.org/">Gearman homepage</a></li>
<li><a href="http://it2.php.net/manual/en/book.gearman.php">PHP Gearman manual</a>.</li>
<li><a href="http://supervisord.org/">Supervisor homepage</a></li>
</ul>

            </div>
            
            <div class="post-comments">
                
<div id="disqus_thread"></div>
<script type="text/plain" class="_iub_cs_activate" data-iub-purposes="3">

(function() {
    // Don't ever inject Disqus on localhost--it creates unwanted
    // discussions from 'localhost:1313' on your Disqus account...
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'daredevel';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>Copyright &copy; 2019 Valerio Galano -
	<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme
</span> -
<a href="https://www.iubenda.com/privacy-policy/521121" class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy ">Privacy Policy</a><script type="text/javascript">(function (w,d) {var loader = function () {var s = d.createElement("script"), tag = d.getElementsByTagName("script")[0]; s.src="https://cdn.iubenda.com/iubenda.js"; tag.parentNode.insertBefore(s,tag);}; if(w.addEventListener){w.addEventListener("load", loader, false);}else if(w.attachEvent){w.attachEvent("onload", loader);}else{w.onload = loader;}})(window, document);</script>
</p>
</footer>

    </body>
