<!DOCTYPE html>
<html>

    <head>
        <title> ReCaptcha in Zend Framework 2 without Zend/Form &middot; Valerio Galano - Software developer </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.62.0" />


<script src="/js/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">


<link rel="stylesheet" href="https://valeriogalano.it/css/nix.css">



<link rel="shortcut icon" href="/img/favicon.ico">








<script type="text/javascript">
    var _iub = _iub || [];
    _iub.csConfiguration = {"lang":"it","siteId":110958,"consentOnLinkAndButton":false,"consentOnElement":null,"consentOnScroll":false,"cookiePolicyId":521121, "banner":{ "acceptButtonDisplay":true,"customizeButtonDisplay":true,"position":"float-top-center","acceptButtonColor":"#0073CE","acceptButtonCaptionColor":"white","customizeButtonColor":"#DADADA","customizeButtonCaptionColor":"#4D4D4D","textColor":"black","backgroundColor":"white" }};
    </script><script type="text/javascript" src="//cdn.iubenda.com/cs/iubenda_cs.js" charset="UTF-8" async></script><meta property="og:title" content="ReCaptcha in Zend Framework 2 without Zend/Form" />
<meta property="og:description" content="The problem Captcha is a very useful mechanism to avoid automated abuse of your sites and applications. In particular,reCAPTCHA is a Google powered service that offers a free and simple way to implement a captcha protection field in your forms or pages. Zend Framework 2 implements his own components to handle captcha and a specific one to handle reCAPTCHA service. At the moment, the ZF2 documentation is very usefull if you want to integrate a reCAPTCHA in your Zend/Form component, but lacks in describing how to use reCAPTCHA service component alone." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://valeriogalano.it/php/recaptcha-in-zend-framework-2-project-using-zendform-component/" />
<meta property="og:image" content="https://valeriogalano.it/img/profile.jpg"/>
<meta property="article:published_time" content="2013-03-15T09:52:36+00:00" />
<meta property="article:modified_time" content="2013-03-15T09:52:36+00:00" /><meta property="og:site_name" content="Valerio Galano" />
<meta itemprop="name" content="ReCaptcha in Zend Framework 2 without Zend/Form">
<meta itemprop="description" content="The problem Captcha is a very useful mechanism to avoid automated abuse of your sites and applications. In particular,reCAPTCHA is a Google powered service that offers a free and simple way to implement a captcha protection field in your forms or pages. Zend Framework 2 implements his own components to handle captcha and a specific one to handle reCAPTCHA service. At the moment, the ZF2 documentation is very usefull if you want to integrate a reCAPTCHA in your Zend/Form component, but lacks in describing how to use reCAPTCHA service component alone.">
<meta itemprop="datePublished" content="2013-03-15T09:52:36&#43;00:00" />
<meta itemprop="dateModified" content="2013-03-15T09:52:36&#43;00:00" />
<meta itemprop="wordCount" content="875">
<meta itemprop="image" content="https://valeriogalano.it/img/profile.jpg"/>



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://valeriogalano.it/img/profile.jpg"/>

<meta name="twitter:title" content="ReCaptcha in Zend Framework 2 without Zend/Form"/>
<meta name="twitter:description" content="The problem Captcha is a very useful mechanism to avoid automated abuse of your sites and applications. In particular,reCAPTCHA is a Google powered service that offers a free and simple way to implement a captcha protection field in your forms or pages. Zend Framework 2 implements his own components to handle captcha and a specific one to handle reCAPTCHA service. At the moment, the ZF2 documentation is very usefull if you want to integrate a reCAPTCHA in your Zend/Form component, but lacks in describing how to use reCAPTCHA service component alone."/>


    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://valeriogalano.it/>valerio@daredevel ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="https://valeriogalano.it/">/home/valerio</a>
				</li>
				
				
				<li class="dropdown">
                    
            		<a href="/post">~/blog</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://pensieriincodice.it/">~/podcast</a>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="container wrapper">
            <h1><a href="https://valeriogalano.it/php/recaptcha-in-zend-framework-2-project-using-zendform-component/">ReCaptcha in Zend Framework 2 without Zend/Form</a></h1>
            <span class="post-date">Mar 15, 2013 </span>
            <div class="post-content">
                <h1 id="the-problem">The problem</h1>
<p>Captcha is a very useful mechanism to avoid automated abuse of your sites and applications. In particular,<a href="http://www.google.com/recaptcha">reCAPTCHA</a> is a Google powered service that offers a free and simple way to implement a captcha protection field in your forms or pages. <a href="http://framework.zend.com/">Zend Framework 2</a> implements his own components to handle captcha and a specific one to handle reCAPTCHA service. At the moment, the ZF2 documentation is very usefull if you want to integrate a reCAPTCHA in your Zend/Form component, but lacks in describing how to use reCAPTCHA service component alone. Actually Zend/Form is very powerful, but sometimes a developer need to use standard html to implement his own forms and this prevents to use ReCaptcha as Zend/Form element.</p>
<h1 id="the-solution">The solution</h1>
<p>To reach our achievement, we will implement a reCAPTCHA service that can be use all over the project to generate captchas and test them against values inserted by user. This service will be used principally in views and controllers. The following code implementation assumes that you have a working ZF2 project, configured as described in official documentation.</p>
<blockquote>
<p>Please, keep in mind that this tutorial was written in March 2013 when stable ZF2 release was 2.1. With new releases, something could work differently.</p>
</blockquote>
<p>Before proceed, you need to register a reCAPTCHA account by clicking <a href="https://www.google.com/recaptcha/admin/create">here</a>. You need to register a Google account, if you don't have, and then configure your keys. At the end of the process, you will posses two keys: public and private.</p>
<p>Now we can start implementation by installing <a href="https://github.com/zendframework/ZendService_ReCaptcha">ZendService/ReCaptcha</a> package that is not included in ZF2 core by default. To perform this operations through <a href="http://getcomposer.org/">composer</a>, let's add the following code (if not just set) to our composer.json file in project root.</p>
<p>/composer.json:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="err">.</span><span class="err">.</span><span class="err">.</span>
    <span class="nt">&#34;repositories&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;composer&#34;</span><span class="p">,</span>
            <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;http://packages.zendframework.com/&#34;</span>
        <span class="p">}</span>
    <span class="p">]</span><span class="p">,</span>
    <span class="err">.</span><span class="err">.</span><span class="err">.</span>
    <span class="nt">&#34;require&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="err">.</span><span class="err">.</span><span class="err">.</span>
        <span class="nt">&#34;zendframework/zendservice-recaptcha&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span>
        <span class="err">.</span><span class="err">.</span><span class="err">.</span>
    <span class="p">}</span>
    <span class="err">.</span><span class="err">.</span><span class="err">.</span>
<span class="p">}</span></code></pre></div>
<p>Now, let's open a terminal and reach project root directory to lunch the composer update command:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ php composer.phar self-update

$ php composer.phar update</code></pre></div>
<p>At the end of the process, if everything goes well, we will find a new folder named <strong>zendservice-recaptcha</strong> in /vendor/zendframework/. Now we can start to configure our reCAPTCHA service.</p>
<p>Let's configure a service in the project called reCaptchaService that we will retrieve in controllers to generate captcha field. Because of we want be able to use different keys for different instances of the application, we will store service configuration in the file local.php. So add the following lines paying attention to replace values with your domain's keys.</p>
<p>/config/autoload/local.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">return array(
     ...
    &#39;recaptcha&#39; =&gt; array(
        &#39;name&#39; =&gt; &#39;recaptcha&#39;,
        &#39;privKey&#39; =&gt; &#39;put here your reCAPTCHA private-key&#39;,
        &#39;pubKey&#39; =&gt; &#39;put here your reCAPTCHA public-key&#39;,
    ),
);</code></pre></td></tr></table>
</div>
</div>
<p>Then, let's insert code to initialize the service.</p>
<p>/config/autoload/global.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">return array(
    ...
    &#39;service_manager&#39; =&gt; array(
        ...
        &#39;factories&#39; =&gt; array(
            ...
            &#39;reCaptchaService&#39; =&gt; function(ZendServiceManagerServiceManager $sm) {
                $config = $sm-&gt;get(&#39;Config&#39;);
                return new ZendCaptchaReCaptcha($config[&#39;recaptcha&#39;]);
            },
        ),
    ),
);</code></pre></td></tr></table>
</div>
</div>
<p>At this point, we have a working service that can be retrieved through ZendServiceManager component. The following code represent an example of how to use ReCaptchaService.</p>
<p>This controller generates and validates the captcha field:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">class IndexController extends AbstractActionController
{
    ...

    public function signupAction()
    {
        // retrieve ReCaptchaService instance and generate a new captcha
        $captcha = $this-&gt;getServiceLocator()-&gt;get(&#39;ReCaptchaService&#39;)-&gt;generate();

        // pass captcha to view
        $viewModel = new ViewModel(array(
            &#39;captcha&#39; =&gt; $captcha,
            &#39;captchaError&#39; =&gt; false,
        ));

        $request = $this-&gt;getRequest();

        // if user submitted form
        if ($request-&gt;isPost()) {

            // check if captcha value is valid
            $resCaptcha = $captcha-&gt;isValid($_POST[&#39;recaptcha_response_field&#39;], $_POST);
            if (!$resCaptcha) {

                // if captcha is not valid, set error field as true
                $viewModel-&gt;setVariable(&#39;captchaError&#39;, true);
            }

            // At this point you can check and use user&#39;s submitted
            // data as you prefer.

            // My preferred approach is to validate form anyway, then
            // perform operations only if captcha is valid. Using this
            // approach I can notify form errors even if captcha value
            // is wrong or missing.

            //---------OPTIONAL (only to have an idea)------------------------//

            // we have an InputFilter because we don&#39;t use ZendForm, but
            // wont renounce to his filter and validation power
            $inputFilter = new UserInputFilterSignup();
            $inputFilter-&gt;setData($request-&gt;getPost());

            if ($inputFilter-&gt;isValid() <span class="err">&amp;</span><span class="err">&amp;</span> $resCaptcha) {
                $data = $inputFilter-&gt;getValues();
                $userService-&gt;setupOnSignUp($data[&#39;email&#39;], $data[&#39;password&#39;], $data);

                return $this-&gt;redirect()-&gt;toRoute(&#39;home&#39;);
            }

           $viewModel-&gt;setVariable(&#39;inputValues&#39;, $inputFilter-&gt;getRawValues());
           $viewModel-&gt;setVariable(&#39;errors&#39;, $inputFilter-&gt;getMessages());
           //-----------------------------------------------------------------//
        }

        return $viewModel;
    }

    ...
}</code></pre></td></tr></table>
</div>
</div>
<p>The correspondent view shows captcha field and an error message, if needed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;...&#34;</span><span class="p">&gt;</span>...
 <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$captcha</span><span class="o">-&gt;</span><span class="na">getService</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getHtml</span><span class="p">();</span><span class="cp">?&gt;</span>

 <span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$captchaError</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
 <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translate</span><span class="p">(</span><span class="s1">&#39;Wrong captcha value&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span>
 <span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
 ...
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div>
<p>Please, note that reCAPTCHA include his own error message. I inserted a second one because I prefer to handle it by myself.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this article we learn how to directly use ZendServiceReCaptcha component. Of course this code can be improved and captcha can be used in a different ways.</p>
<p>All comments and questions are welcome.</p>

            </div>
            
            <div class="post-comments">
                
<div id="disqus_thread"></div>
<script type="text/plain" class="_iub_cs_activate" data-iub-purposes="3">

(function() {
    // Don't ever inject Disqus on localhost--it creates unwanted
    // discussions from 'localhost:1313' on your Disqus account...
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'daredevel';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>Copyright &copy; 2019 Valerio Galano -
	<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme
</span> -
<a href="https://www.iubenda.com/privacy-policy/521121" class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy ">Privacy Policy</a><script type="text/javascript">(function (w,d) {var loader = function () {var s = d.createElement("script"), tag = d.getElementsByTagName("script")[0]; s.src="https://cdn.iubenda.com/iubenda.js"; tag.parentNode.insertBefore(s,tag);}; if(w.addEventListener){w.addEventListener("load", loader, false);}else if(w.attachEvent){w.attachEvent("onload", loader);}else{w.onload = loader;}})(window, document);</script>
</p>
</footer>

    </body>
